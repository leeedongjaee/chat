<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>채팅방</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        display: flex;
        height: 100vh;
        box-sizing: border-box;
        background-color: #ffffff;
        color: #000;
        transition: background-color 0.3s, color 0.3s;
      }

      #left {
        flex: 3;
        display: flex;
        flex-direction: column;
        margin-right: 20px;
      }

      #right {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      #userTitle {
        font-size: 20px;
        margin-bottom: 10px;
      }

      #chat {
        flex: 1;
        border: 1px solid #ccc;
        padding: 10px;
        overflow-y: auto;
        background-color: #f9f9f9;
        margin-bottom: 10px;
      }

      #messageForm {
        display: flex;
      }

      #messageInput {
        flex: 1;
        height: 40px;
        font-size: 16px;
        padding: 5px;
      }

      #sendBtn {
        height: 40px;
        font-size: 16px;
        padding: 0 20px;
        margin-left: 10px;
        cursor: pointer;
      }

      #fileInput {
        margin-top: 10px;
      }

      #userList,
      #fileList {
        border: 1px solid #aaa;
        background: #f1f1f1;
        padding: 10px;
        margin-bottom: 10px;
        overflow-y: auto;
      }

      #userList {
        height: 150px;
      }

      #fileList {
        flex: 1;
      }

      .chat-image {
        max-width: 200px;
        display: block;
        margin-top: 5px;
      }

      .file-item {
        margin-bottom: 5px;
      }

      #darkModeToggle {
        position: fixed;
        top: 10px;
        right: 20px;
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
        background-color: #eee;
        border: 1px solid #ccc;
        border-radius: 5px;
        z-index: 1000;
      }

      /* 다크모드 */
      body.dark-mode {
        background-color: #1e1e1e;
        color: #eee;
      }

      body.dark-mode #chat,
      body.dark-mode #userList,
      body.dark-mode #fileList {
        background-color: #2c2c2c;
        border-color: #555;
      }

      body.dark-mode #messageInput,
      body.dark-mode #sendBtn,
      body.dark-mode #fileInput {
        background-color: #444;
        color: #fff;
        border: 1px solid #666;
      }

      body.dark-mode #darkModeToggle {
        background-color: #555;
        color: #fff;
        border-color: #888;
      }
    </style>
  </head>
  <body>
    <button id="darkModeToggle">🌙 다크모드</button>

    <div id="left">
      <h2 id="userTitle"></h2>
      <div id="chat"></div>
      <form id="messageForm" onsubmit="return false;">
        <input
          type="text"
          id="messageInput"
          placeholder="메시지를 입력하세요"
        />
        <button id="sendBtn">전송</button>
      </form>
      <input type="file" id="fileInput" />
    </div>

    <div id="right">
      <div id="userList">
        <h3>접속자 목록</h3>
        <ul id="users"></ul>
      </div>
      <div id="fileList">
        <h3>업로드된 파일</h3>
        <ul id="files"></ul>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const nickname = params.get('nickname') || '익명';

      const chat = document.getElementById('chat');
      const input = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const fileInput = document.getElementById('fileInput');
      const title = document.getElementById('userTitle');
      const usersUl = document.getElementById('users');
      const filesUl = document.getElementById('files');
      const darkToggle = document.getElementById('darkModeToggle');

      title.textContent = `${nickname}님, 환영합니다!`;

      const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(`${protocol}://${location.host}`);

      ws.onopen = () => {
        ws.send(JSON.stringify({ type: 'join', nickname }));
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);

          if (data.type === 'userList') {
            usersUl.innerHTML = '';
            data.users.forEach((user) => {
              const li = document.createElement('li');
              li.textContent = user;
              usersUl.appendChild(li);
            });
          } else if (data.type === 'message') {
            const div = document.createElement('div');
            div.textContent = `${data.from}: ${data.message}`;
            chat.appendChild(div);
          } else if (data.type === 'file') {
            const isImage = /\.(jpg|jpeg|png|gif)$/i.test(data.filename);
            const div = document.createElement('div');
            div.innerHTML = `<strong>${data.from}:</strong>`;
            if (isImage) {
              const img = document.createElement('img');
              img.src = `/uploads/${data.filename}`;
              img.className = 'chat-image';
              div.appendChild(img);
            } else {
              const link = document.createElement('a');
              link.href = `/uploads/${data.filename}`;
              link.target = '_blank';
              link.textContent = data.originalname;
              div.appendChild(link);
            }
            chat.appendChild(div);

            const fileLi = document.createElement('li');
            fileLi.className = 'file-item';
            const fileLink = document.createElement('a');
            fileLink.href = `/uploads/${data.filename}`;
            fileLink.target = '_blank';
            fileLink.textContent = `${data.from}: ${data.originalname}`;
            fileLi.appendChild(fileLink);
            filesUl.appendChild(fileLi);
          }

          chat.scrollTop = chat.scrollHeight;
        } catch (e) {
          console.error('메시지 처리 오류:', e);
        }
      };

      sendBtn.addEventListener('click', () => {
        const message = input.value.trim();
        if (message !== '') {
          ws.send(JSON.stringify({ type: 'message', message }));
          input.value = '';
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendBtn.click();
        }
      });

      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('nickname', nickname);

        fetch('/upload', {
          method: 'POST',
          body: formData,
        }).then(() => {
          fileInput.value = '';
        });
      });

      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        darkToggle.textContent = '☀️ 라이트모드';
      }

      darkToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        darkToggle.textContent = isDark ? '☀️ 라이트모드' : '🌙 다크모드';
      });
    </script>
  </body>
</html>
